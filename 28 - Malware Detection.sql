WITH ranked_runs AS (
  SELECT
    software_id,
    run_date,
    malware_detected,
    ROW_NUMBER() OVER (PARTITION BY software_id ORDER BY run_date DESC) AS rn,
    COUNT(*) OVER (PARTITION BY software_id) AS run_count
  FROM malware
),

latest_and_previous AS (
  SELECT
    software_id,
    MAX(CASE WHEN rn = 1 THEN malware_detected END) AS latest_run_count,
    MAX(CASE WHEN rn = 2 THEN malware_detected END) AS previous_run_count,
    MAX(CASE WHEN rn = 1 THEN malware_detected END) AS latest_malware,
    run_count
  FROM ranked_runs
  WHERE rn <= 2
  GROUP BY software_id, run_count
)

SELECT
  software_id,
  latest_run_count,
  latest_run_count - previous_run_count AS difference_to_previous
FROM latest_and_previous
WHERE run_count >= 2                  -- at least 2 runs
  AND latest_malware >= 10            -- at least 10 malware detected in latest run
ORDER BY software_id;
